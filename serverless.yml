service: serverless-fastapi-scheduler-template
frameworkVersion: '4'

provider:
  name: aws
  runtime: python3.11
  architecture: arm64
  region: ${env:AWS_REGION, 'us-east-1'}
  stage: ${opt:stage, 'dev'}
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize, 512}
  timeout: 15
  logRetentionInDays: ${self:custom.stages.${self:provider.stage}.logRetentionInDays, 14}
  environment:
    STAGE: ${self:provider.stage}
    API_BASE_PATH: ${env:API_BASE_PATH, ''}
    ROOT_PATH: ${env:ROOT_PATH, ''}
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: "*"
        - Effect: Allow
          Action:
            - sqs:SendMessage
          Resource:
            - !GetAtt NightlyCleanupUtcDlq.Arn
            - !GetAtt SyncThingsUtcDlq.Arn

package:
  individually: false
  patterns:
    - '!tests/**'
    - '!**/__pycache__/**'
    - '!**/*.pyc'
    - '!node_modules/**'
    - '!package.json'
    - '!package-lock.json'
    - '!.venv/**'
    - '!.git/**'
    - '!.github/**'
    - '!.serverless/**'
    - '!.pytest_cache/**'
    - '!.ruff_cache/**'
    - '!.mypy_cache/**'
    - '!*.md'
    - '!.env*'
    - '!Makefile'
    - '!requirements-dev.txt'

custom:
  stages:
    dev:
      memorySize: 512
      logRetentionInDays: 7
      schedulesEnabled: false
    prod:
      memorySize: 1024
      logRetentionInDays: 30
      schedulesEnabled: true

functions:
  api:
    handler: src/handlers/http_handler.handler
    events:
      - httpApi:
          method: ANY
          path: /{proxy+}

  nightlyCleanupUtc:
    handler: src/handlers/task_handlers.nightly_handler_utc
    description: Nightly cleanup at 02:00 UTC
    events:
      - schedule:
          rate: cron(0 2 * * ? *)
          enabled: ${self:custom.stages.${self:provider.stage}.schedulesEnabled}

  syncThingsUtc:
    handler: src/handlers/task_handlers.sync_handler_utc
    description: Sync every 1 minutes
    events:
      - schedule:
          rate: rate(1 minute)
          enabled: ${self:custom.stages.${self:provider.stage}.schedulesEnabled}

resources:
  Resources:
    NightlyCleanupUtcDlq:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: !Sub "${self:service}-${self:provider.stage}-nightly-utc-dlq"
        MessageRetentionPeriod: 1209600

    SyncThingsUtcDlq:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: !Sub "${self:service}-${self:provider.stage}-sync-utc-dlq"
        MessageRetentionPeriod: 1209600

    NightlyCleanupUtcInvokeConfig:
      Type: AWS::Lambda::EventInvokeConfig
      Properties:
        FunctionName: !Ref NightlyCleanupUtcLambdaFunction
        Qualifier: "$LATEST"
        MaximumRetryAttempts: 2
        DestinationConfig:
          OnFailure:
            Destination: !GetAtt NightlyCleanupUtcDlq.Arn

    SyncThingsUtcInvokeConfig:
      Type: AWS::Lambda::EventInvokeConfig
      Properties:
        FunctionName: !Ref SyncThingsUtcLambdaFunction
        Qualifier: "$LATEST"
        MaximumRetryAttempts: 2
        DestinationConfig:
          OnFailure:
            Destination: !GetAtt SyncThingsUtcDlq.Arn
